# å»ºç«‹ News ç¨‹å¼

## çµ‚ç«¯è¼¸å…¥ï¼Œå»ºç«‹ News çš„ migrationã€modelã€factory

```bash
php artisan make:model News -mf
```

---

## è¨­å®š News çš„ migration æª”æ¡ˆ

å»ºè­°æ’åºï¼Œè·Ÿå•Ÿç”¨æ¬„ä½ï¼Œä»¥åŠåœ–ç‰‡è·¯å¾‘éƒ½ç”¨é€™å€‹å‘½åï¼Œé€™æ¨£æ¥ä¸‹ä¾†çš„çµ„ä»¶å…§å®¹éƒ½å¯ä»¥ä¸ç”¨ä¿®æ”¹

```php
    public function up(): void
    {
        Schema::create('news', function (Blueprint $table) {
            $table->id();
            $table->string('title'); // æ¨™é¡Œ
            $table->text('body'); // å…§å®¹
            $table->text('locale'); // èªç³»
            $table->string('image_url')->nullable(); // åœ–ç‰‡ -> å»ºè­°ç”¨é€™å€‹å‘½å
            $table->integer('sort_number')->default(1); // æ’åº -> å»ºè­°ç”¨é€™å€‹å‘½å
            $table->boolean('is_active')->default(true); // æ˜¯å¦å•Ÿç”¨ -> å»ºè­°ç”¨é€™å€‹å‘½å
            $table->timestamps();
        });
    }
```

## è¨­å®š model è³‡æ–™åº«æ¬Šé™

```php
protected $guarded = [];
```

---

## è¨­å®š News çš„ factory æª”æ¡ˆ

```php
return [
    'title' => $this->faker->realText(30),
    'body' => $this->faker->realText(1000),
    'locale' => fake()->randomElement(['zh_TW', 'en_US']), //å¢åŠ èªç³»
];
```

---

## è¨­å®š seeder æª”æ¡ˆ

è·¯å¾‘ `database\seeders\DatabaseSeeder.php`

```php
// è¨˜å¾—import Namespace
News::factory(10)->create();
```

---

## é–‹å•Ÿçµ‚ç«¯æ©Ÿï¼Œè¼¸å…¥ä»¥ä¸‹æŒ‡ä»¤ï¼Œå»ºç«‹ Livewire çš„ component

å‹™å¿…è¦ä½¿ç”¨ pages::backend / å‰ç«¯ pages::frontend

```bash
# å¾Œå°åˆ—è¡¨
php artisan livewire:make pages::backend.news.index
# å¾Œå°ç·¨è¼¯
php artisan livewire:make pages::backend.news.edit
```

## å»ºç«‹ stroageLink

```bash
php artisan storage:link
```

---

## è¨­å®šè·¯ç”±

è·¯å¾‘: `routes/gd-admin.php`

```php
    [
        'title' => 'æœ€æ–°æ¶ˆæ¯',
        'show' => true,
        'expanded' => true,
        'children' => [
            [
                'title' => 'åˆ—è¡¨',
                'route' => 'news.index',
                'url' => 'news',
                'page' => 'backend.news.index',
                'show' => true,
                'locales' => $gdAdminLocales,
            ],
            [
                'title' => 'æ–°å¢',
                'route' => 'news.edit',
                'url' => 'news/edit/{id?}',
                'page' => 'backend.news.edit',
                'show' => false,
                'locales' => $gdAdminLocales,
            ],
        ],
    ],
```

## åŸ·è¡Œè³‡æ–™åº«é·ç§»

```bash
#é–‹ç™¼ä¸­æ‰€ä»¥refresh
php artisan migrate:refresh --seed
```

---

## ç·¨è¼¯ `resources\views\pages\backend\news\âš¡index.blade.php`

æœ€é‡è¦çš„æ˜¯#[Layout('layouts.gd-admin')] é€™è¡Œï¼Œæœªä¾†å»ºç«‹å…¶ä»–ç¨‹å¼éƒ½è¦è¨˜å¾—ç”¨ gd-admin çš„æ¨¡æ¿ï¼Œå…¶ä»–ç´°ç¯€è«‹åƒè€ƒä¸‹é¢å®Œæ•´ç¨‹å¼ç¢¼

```php
<?php

use App\Livewire\Backend\Traits\BulkActionsTrait;
use App\Livewire\Backend\Traits\FilterableTrait;
use App\Livewire\Backend\Traits\SetupTrait;
use App\Livewire\Backend\Traits\SingleActionTrait;
use App\Models\News;
use Illuminate\Database\Eloquent\Builder;
use Livewire\Attributes\Computed;
use Livewire\Attributes\Layout;
use Livewire\Component;
use Livewire\WithPagination;

new #[Layout('layouts.gd-admin')] class extends Component {
    use BulkActionsTrait, FilterableTrait, SetupTrait, SingleActionTrait, WithPagination;

    // æ¯é é¡¯ç¤ºæ•¸é‡
    public int $perPage = 12;

    // åˆå§‹åŒ–é é¢ï¼šæ³¨å…¥ Modelã€æ¨™é¡Œã€èªç³»æ¸…å–®
    public function mount($pageTitle = null, $parentTitle = null, $locales = [])
    {
        $this->setupTrait(currentModel: new News(), pageTitle: $pageTitle, parentTitle: $parentTitle, locales: $locales);
    }

    // çµ±ä¸€æŸ¥è©¢å…¥å£ï¼šä½¿ç”¨ FilterableTrait çš„æ¢ä»¶ä¸¦å¯åœ¨æ­¤æ“´å……
    protected function bulkBaseQuery(): Builder
    {
        $query = $this->createBaseQuery(searchColumns: ['title']);

        // é—œä¿‚æ¨¡çµ„ï¼ˆç¯„ä¾‹ï¼‰
        // å–®ä¸€é—œè¯ç¯©é¸
        // if (!empty($this->tagId)) {
        //     $query->whereHas('tags', fn ($q) => $q->whereKey($this->tagId));
        // }
        //
        // å¤šå€‹é—œè¯ç¯©é¸
        // if (!empty($this->tagIds)) {
        //     $query->whereHas('tags', fn ($q) => $q->whereIn('tags.id', $this->tagIds));
        // }

        // éœ€è¦æ“´å……æ¢ä»¶æ™‚ï¼Œåœ¨é€™è£¡è¿½åŠ  where/whereHas

        return $query;
    }

    /*
    // å‚™è¨»ï¼šè‹¥è¦åœ¨ã€Œæ‰¹æ¬¡åˆªé™¤ã€æ™‚æ¸…æ‰é—œè¯è³‡æ–™ï¼Œå¯åœ¨é€™è£¡å¯¦ä½œ
    // ä¾‹å¦‚ï¼šå…ˆåˆª news_imagesï¼Œå†åˆª newsï¼ˆåªåˆªè³‡æ–™åº«ï¼Œä¸åˆªæª”æ¡ˆï¼‰
    protected function handleBulkDelete(Builder $query, array $ids): void
    {
        $models = $query->get();

        foreach ($models as $model) {
            $model->newsImages()->delete();
            $model->delete();
        }
    }
    */

    // BulkActionsTrait éœ€è¦ï¼šå›å‚³ã€Œç•¶å‰é ã€çš„ ID åˆ—è¡¨
    public function getPageIds(): array
    {
        return $this->bulkBaseQuery()->paginate($this->perPage)->getCollection()->pluck('id')->toArray();
    }

    // å–å¾—åˆ—è¡¨è³‡æ–™ï¼ˆåˆ†é æˆ–å®Œæ•´ï¼‰
    public function getResult($paginate = true)
    {
        $query = $this->bulkBaseQuery();

        return $paginate ? $query->paginate($this->perPage) : $query->get();
    }

    // æä¾› Blade ä½¿ç”¨çš„åˆ†é è³‡æ–™
    #[Computed]
    public function items()
    {
        return $this->getResult(true);
    }
};
?>

<div>
    {{-- è³‡æ–™åç¨± --}}
    @php($items = $this->items)
    {{-- æ‰¹é‡è·Ÿé¸å–åŠŸèƒ½ --}}
    @include('livewire.backend.share.bulk-actions')
    {{-- ç¯©é¸è·Ÿæœå°‹åŠŸèƒ½ --}}
    @include('livewire.backend.share.filterable')


    {{-- ä¸»åˆ—è¡¨ --}}
    @php($currentPage = $items->currentPage())

    <main class="2xl:max-w-5xl container">
        <!--æ–°å¢æŒ‰éˆ•-->
        <flux:button wire:show="true" href="{{ route('gd-admin.news.edit') . '?locale=' . $traitLocale }}"
            icon:trailing="plus">
            æ–°å¢
        </flux:button>

        <!-- åˆ—è¡¨é–‹å§‹-è‡ªè¨‚å€ -->
        <ul class="space-y-4 mt-4">
            @forelse ($items as $item)
                <li class="dark:bg-zinc-900 bg-zinc-100 w-full p-4 rounded-xl" wire:key="list-{{ $item->id }}">
                    <article class="lg:flex space-y-4 lg:space-y-0 justify-between gap-x-0 lg:gap-x-4 items-center">

                        <!-- åœ–ç‰‡å€ -->
                        <figure wire:show="true">
                            @if (isset($item->image_url))
                                <img src="{{ Str::startsWith($item->image_url, ['http://', 'https://']) ? $item->image_url : Storage::url($item->image_url) }}"
                                    class="size-12 rounded-full object-cover" alt="">
                            @else
                                <flux:avatar circle class="size-12" initials="ç„¡" />
                            @endif
                        </figure>


                        <!--èªç³»æ¨™ç±¤-->
                        <flux:badge variant="color" color="red" class="text-xs">{{ $item->locale }}</flux:badge>

                        <!-- å…§å®¹å€ -->
                        <section wire:show="true" class="flex-1 break-all">
                            <p class="text-xs opacity-50">å»ºç«‹æ—¥æœŸï¼š{{ $item->created_at->format('Y.m.d') }}</p>
                            <p>
                                {{ $item->title }}
                            </p>
                        </section>

                        <!-- é¸å–®å€ -->
                        <flux:button.group class="place-self-center md:place-self-end lg:place-self-auto">
                            <!-- é¸å–æ¡† -->
                            <flux:button wire:show="true">
                                <flux:checkbox wire:model.live="traitSelected" value="{{ $item->id }}"
                                    label="é¸å–" />
                            </flux:button>

                            <!-- åŸºæœ¬åŠŸèƒ½éˆ•ï¼Œæ’åºã€å•Ÿç”¨ -->
                            <!-- ä¸Šæ¶ç‹€æ…‹ -->
                            <flux:button wire:show="true">
                                <flux:tooltip content="{{ $item->is_active ? 'é—œé–‰' : 'å•Ÿç”¨' }}">
                                    <flux:switch :checked="(bool) $item->is_active"
                                        wire:click="toggleActiveTrait({{ $item->id }})" />
                                </flux:tooltip>
                            </flux:button>

                            <!-- æ’åºæŒ‰éˆ• -->
                            <flux:tooltip wire:show="true" content="æ’åº">
                                <flux:button class="min-w-24" icon="numbered-list"
                                    wire:click="openSortNumberModalTrait({{ $item->id }})">
                                    {{ $item->sort_number }}
                                </flux:button>
                            </flux:tooltip>

                            <!-- ç·¨è¼¯é¸å–® -->
                            <flux:dropdown position="bottom" align="end">
                                <flux:button icon="ellipsis-horizontal" />
                                <flux:navmenu>
                                    <flux:navmenu.item
                                        href="{{ route('gd-admin.news.edit', array_filter(['id' => $item->id, 'locale' => $item->locale, 'page' => $currentPage], fn($value) => $value !== null && $value !== '')) }}"
                                        icon="pencil-square">
                                        ç·¨è¼¯
                                    </flux:navmenu.item>
                                </flux:navmenu>
                            </flux:dropdown>
                        </flux:button.group>

                    </article>
                </li>
            @empty
                <div class="text-center">ğŸ˜‰æ²’æœ‰é …ç›®</div>
            @endforelse
        </ul>
        <!-- åˆ—è¡¨çµæŸ-è‡ªè¨‚å€ -->

        {{-- åˆ†é  --}}
        <div class="pb-20">
            <x-gd-admin.gd-admin-pagination :paginator="$this->items" />
        </div>
    </main>

    {{-- å‹•æ…‹è¦–çª—ï¼ŒåŸºæœ¬æœ‰æ”¾æ’åºçš„ä¿®æ”¹ï¼Œå¦‚è¦æ·»åŠ åœ¨å¢åŠ æ–¼æ­¤ --}}
    @include('livewire.backend.share.modals')
</div>
```

---

## ç·¨è¼¯ `resources\views\pages\backend\news\âš¡edit.blade.php`

æœ€é‡è¦çš„æ˜¯#[Layout('layouts.gd-admin')]

```php
<?php

use App\Livewire\Backend\Traits\HasImageRelationsTrait;
use App\Livewire\Backend\Traits\SetupTrait;
use App\Models\News;
use Livewire\Attributes\Layout;
use Livewire\Attributes\Locked;
use Livewire\Component;

new #[Layout('layouts.gd-admin')] class extends Component
{
    // ä½¿ç”¨é€šç”¨çš„ SetupTrait
    use HasImageRelationsTrait, SetupTrait;

    #[Locked]
    public $id; // ç•¶å‰è³‡æ–™çš„å”¯ä¸€è­˜åˆ¥ç¢¼

    public $title = ''; // è³‡æ–™çš„æ¨™é¡Œ

    public $body = ''; // è³‡æ–™çš„å…§å®¹

    public $locale = 'zh_TW'; // èªç³»è¨­å®šï¼Œé è¨­ç‚ºç¹é«”ä¸­æ–‡

    public $sortNumber = 1; // æ’åºç·¨è™Ÿï¼Œé è¨­ç‚º 1

    public $isActive = true; // æ˜¯å¦å•Ÿç”¨ï¼Œé è¨­ç‚ºå•Ÿç”¨

    public array $images = []; // ä¸Šå‚³çš„åœ–ç‰‡é™£åˆ—

    public int $maxImageSize = 3072; // æœ€å¤§åœ–ç‰‡å¤§å°ï¼Œå–®ä½ç‚º KB

    public int $maxImages = 1; // å–®å¼µåœ–ç‰‡ä¸Šå‚³è¨­å®šç‚º 1

    public ?int $returnPage = null; // è¿”å›çš„é ç¢¼ï¼Œç”¨æ–¼é‡å®šå‘å›åˆ—è¡¨é é¢

    /**
     * åˆå§‹åŒ–å…ƒä»¶ï¼Œæ ¹æ“šæ˜¯å¦ç‚ºæ–°å¢æˆ–ç·¨è¼¯æ¨¡å¼é€²è¡Œè¨­ç½®
     *
     * @param  mixed  $id  è³‡æ–™çš„å”¯ä¸€è­˜åˆ¥ç¢¼
     * @param  string|null  $parentTitle  çˆ¶å±¤æ¨™é¡Œ
     * @param  array  $locales  å¯ç”¨çš„èªç³»åˆ—è¡¨
     */
    public function mount($id = null, $parentTitle = null, $locales = [])
    {
        $this->id = $id;
        $this->returnPage = request()->query('page');

        // è¨­ç½®é€šç”¨çš„ trait å±¬æ€§
        $this->setupTrait(
            currentModel: new News, // ç•¶å‰æ¨¡å‹
            pageTitle: $this->isCreating() ? 'æ–°å¢' : 'ç·¨è¼¯', // é é¢æ¨™é¡Œ
            parentTitle: $parentTitle, // çˆ¶å±¤æ¨™é¡Œ
            locales: $locales, // å¯ç”¨çš„èªç³»åˆ—è¡¨
        );

        // è¼‰å…¥ç·¨è¼¯æ¨¡å¼çš„è³‡æ–™
        $this->loadEditData();
    }

    /**
     * æ ¹æ“šæ¨¡å¼è¼‰å…¥è³‡æ–™
     */
    protected function loadEditData(): void
    {
        if ($this->isCreating()) {
            // æ–°å¢æ¨¡å¼ä¸‹ï¼Œè¨­ç½®é è¨­èªç³»
            $defaultLocale = array_key_first($this->traitLocales) ?? 'zh_TW';
            $traitLocale = request()->input('locale', $defaultLocale);
            $this->locale = $traitLocale === 'All' || empty($traitLocale) ? 'zh_TW' : $traitLocale;

            return;
        }

        // ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œå¾è³‡æ–™åº«è¼‰å…¥è³‡æ–™
        $model = $this->traitModel::query()->findOrFail($this->id);
        $this->fillFromModel($model);
    }

    /**
     * å°‡è³‡æ–™åº«æ¨¡å‹çš„å€¼å¡«å……åˆ°å…ƒä»¶å±¬æ€§ä¸­
     *
     * @param  mixed  $model  è³‡æ–™åº«æ¨¡å‹(ç¶å®šä»»æ„æ¨¡å‹å¦‚ News Products)
     */
    protected function fillFromModel($model): void
    {
        $this->title = $model->title;
        $this->body = $model->body;
        $this->locale = $model->locale;
        $this->sortNumber = $model->sort_number;
        $this->isActive = $model->is_active;
        $this->images = $model->image_url ? (array) $model->image_url : []; // å–®å¼µ
        // $this->images = $model->newsImages?->pluck('image_url')?->toArray() ?? []; // å¤šå¼µ
    }

    /**
     * é©—è­‰ä¸¦è¿”å›è¡¨å–®è³‡æ–™
     */
    protected function getValidatedData(): array
    {
        // é©—è­‰è¡¨å–®è¼¸å…¥
        $this->validate([
            'title' => ['required', 'max:255'], // æ¨™é¡Œç‚ºå¿…å¡«ï¼Œä¸”é•·åº¦ä¸å¾—è¶…é 255 å­—å…ƒ
            'body' => ['nullable', 'string'], // å…§å®¹ç‚ºå¯é¸ï¼Œä¸”å¿…é ˆç‚ºå­—ä¸²
            'locale' => ['required', 'string'], // èªç³»ç‚ºå¿…å¡«ï¼Œä¸”å¿…é ˆç‚ºå­—ä¸²
            'sortNumber' => ['required', 'integer', 'min:1'], // æ’åºç·¨è™Ÿç‚ºå¿…å¡«ï¼Œä¸”å¿…é ˆç‚ºå¤§æ–¼ç­‰æ–¼ 1 çš„æ•´æ•¸
            'isActive' => ['boolean'], // å•Ÿç”¨ç‹€æ…‹å¿…é ˆç‚ºå¸ƒæ—å€¼
        ]);

        // å¦‚æœåœ–ç‰‡ä¸è¦å¿…å¡«ï¼Œè¨»è§£æ‰é€™è¡Œ
        $this->validate(
            [
                'images' => ['required', 'array', 'min:1'],
                'images.*' => ['string'],
            ],
            [
                'images.required' => 'è«‹ä¸Šå‚³åœ–ç‰‡',
                'images.min' => 'è‡³å°‘éœ€è¦ä¸€å¼µåœ–ç‰‡',
            ],
        );

        // è¿”å›é©—è­‰å¾Œçš„è³‡æ–™
        return [
            'title' => $this->title,
            'body' => $this->body,
            'image_url' => $this->images[0] ?? null,
            'locale' => $this->locale,
            'sort_number' => $this->sortNumber,
            'is_active' => $this->isActive,
        ];
    }

    /**
     * å„²å­˜è³‡æ–™ï¼Œæ ¹æ“šæ¨¡å¼åŸ·è¡Œæ–°å¢æˆ–æ›´æ–°æ“ä½œ
     */
    public function save()
    {
        $data = $this->getValidatedData(); // ç²å–é©—è­‰å¾Œçš„è³‡æ–™
        $message = $this->isCreating() ? 'æ–°å¢æˆåŠŸ' : 'ç·¨è¼¯æˆåŠŸ'; // è¨­ç½®æ“ä½œæˆåŠŸè¨Šæ¯

        if ($this->isCreating()) {
            // æ–°å¢æ¨¡å¼ï¼Œå‰µå»ºæ–°è³‡æ–™
            $model = $this->traitModel::query()->create($data);
        } else {
            // ç·¨è¼¯æ¨¡å¼ï¼Œæ›´æ–°ç¾æœ‰è³‡æ–™
            $model = $this->traitModel::query()->findOrFail($this->id);
            $model->update($data);
        }

        // åŒæ­¥é—œè¯åœ–ç‰‡ï¼ˆå–®å‚³æ™‚è¨»è§£ï¼‰
        // $this->syncImageRelation($model, $this->images, relation: 'newsImages');

        // è¨­ç½®æˆåŠŸè¨Šæ¯åˆ° session
        session()->flash('gd-session-message', $message);

        // é‡å®šå‘åˆ°æ–°èåˆ—è¡¨é é¢ï¼ˆä¿ç•™åˆ†é ï¼‰
        return redirect()->route(
            'gd-admin.news.index',
            array_filter(
                [
                    'page' => $this->returnPage,
                ],
                fn ($value) => $value !== null,
            ),
        );
    }

    /**
     * åˆ¤æ–·æ˜¯å¦ç‚ºæ–°å¢æ¨¡å¼
     */
    protected function isCreating(): bool
    {
        return $this->id === null || $this->id === 'add';
    }
};
?>

<div>
    <main class="w-full mx-auto space-y-4">
        <h1>{{ $traitPageTitle }}</h1>
        <form wire:submit.prevent="save" class="block lg:flex lg:gap-x-10 space-y-10 lg:space-y-0">
            <!-- LEFT SIDE -->
            <section class="space-y-4 flex-1 min-w-0">

                <!-- å¤šå‚³åœ–ç‰‡ $maxImages(æ”¹ç‚º1çš„æ™‚å€™å°±æ˜¯å–®å‚³åœ–ç‰‡) -->
                <div>
                    <livewire:gd-multople-upload-image wire:model="images" :max-images="$maxImages" :max-file-size="$maxImageSize"
                        :error-message="$errors->first('images')" />
                </div>

                <!-- ä¸€èˆ¬Input -->
                <flux:field>
                    <flux:label>æ–‡ç« æ¨™é¡Œ</flux:label>
                    <flux:input wire:model="title" />
                    <flux:error name="title" />
                </flux:field>

                <!-- Tinymceç·¨è¼¯å™¨ -->
                <flux:field>
                    <flux:label>æ–‡ç« å…§å®¹</flux:label>
                    @island(name: 'body-editor')
                        <livewire:gd-tinymce-editor wire:model="body" wire:key="body-editor" />
                    @endisland
                    <flux:error name="body" />
                </flux:field>

            </section>

            <!-- RIGHT SIDE -->
            <section class="w-full lg:w-80 lg:shrink-0">
                <div class="sticky top-10 space-y-4 ">
                    <!-- èªç³» -->
                    <flux:field>
                        <flux:input.group>
                            <flux:input.group.prefix>èªç³»</flux:input.group.prefix>
                            <flux:dropdown class="w-full">
                                <flux:button class="min-w-full" icon:trailing="chevron-down">
                                    {{ $locale }}
                                </flux:button>
                                <flux:menu>
                                    <flux:menu.radio.group wire:model.live="locale">
                                        @foreach ($traitLocales as $key => $localeItem)
                                            <flux:menu.radio value="{{ $key }}">{{ $localeItem }}
                                            </flux:menu.radio>
                                        @endforeach
                                    </flux:menu.radio.group>
                                </flux:menu>
                            </flux:dropdown>
                        </flux:input.group>
                        <flux:error name="locale" />
                    </flux:field>

                    <!-- æ’åº -->
                    <flux:field>
                        <flux:input.group>
                            <flux:input.group.prefix>æ’åº</flux:input.group.prefix>
                            <flux:input mask="99999" wire:model="sortNumber" />
                        </flux:input.group>
                        <flux:error name="sortNumber" />
                    </flux:field>


                    <flux:button type="submit" variant="primary" class="w-full">ä¿å­˜</flux:button>
                </div>
            </section>
        </form>
    </main>
</div>

```

---

## å®Œæˆæœ€æ–°æ¶ˆæ¯ç¨‹å¼
