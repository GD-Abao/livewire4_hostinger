# 建立 News 程式 + 圖片多傳功能

請先看[建立程式方法](建立程式方法.md) 了解基本架構與 Livewire 的使用方式。

---

## 建立 NewsImage

```bash
php artisan make:model NewsImage -m
```

---

## 修改 NewsImage migration 檔案

```php
    public function up(): void
    {
        Schema::create('news_images', function (Blueprint $table) {
            $table->id();
            $table->unsignedBigInteger('news_id'); // 關聯 news 表的外鍵
            $table->string('image_url'); // 圖片網址
            $table->unsignedInteger('sort_number')->default(0); // 排序編號，預設為 0
            $table->timestamps();
            $table->index(['news_id', 'sort_number']); // 建立索引以提升查詢效能
        });
    }
```

---

## 修改 NewsImage Model

```php
class NewsImage extends Model
{
    protected $guarded = [];

    // 關聯 News 模型
    public function news()
    {
        return $this->belongsTo(\App\Models\News::class);
    }
}
```

---

## 修改 News Model

```php
class News extends Model
{
    protected $guarded = [];

    // 關聯 NewsImage 模型
    public function newsImages()
    {
        return $this->hasMany(\App\Models\NewsImage::class)->orderBy('sort_number');
    }
}
```

---

## 執行 migration

```bash
#開發中所以refresh
php artisan migrate:refresh --seed
```

---

## 完成 NewsImage 建立

---

## 修改 resources\views\pages\backend\news\⚡edit.blade.php

`修改圖片數量`

```php
    // 多傳記得要改1以上
    public int $maxImages = 5; // 單張圖片上傳設定為 1
```

---

`填充模型資料的地方改成多傳圖片`
`newsImages 是關聯模型`

```php
    protected function fillFromModel($model): void
    {
        $this->title = $model->title;
        $this->body = $model->body;
        $this->locale = $model->locale;
        $this->sortNumber = $model->sort_number;
        $this->isActive = $model->is_active;
        // $this->images = $model->image_url ? (array) $model->image_url : []; // 單張
        $this->images = $model->newsImages?->pluck('image_url')?->toArray() ?? []; // 多張
    }
```

---

```php
    /**
     * 儲存資料，根據模式執行新增或更新操作
     */
    public function save()
    {
        $data = $this->getValidatedData(); // 獲取驗證後的資料
        $message = $this->isCreating() ? '新增成功' : '編輯成功'; // 設置操作成功訊息

        .....程式碼省略.....

        // 打開這裡是多傳圖片功能 從HasImageRelationsTrait 處理關係模組
        $this->syncImageRelation($model, $this->images, relation: 'newsImages');

        // 設置成功訊息到 session
        session()->flash('gd-session-message', $message);


    }
```

## 完成 NewsImage 多傳圖片功能建立
